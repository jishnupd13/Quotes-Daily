trigger:
  branches:
    include:
      - development   # Trigger only on development branch

pool:
  name: Default   # Self-hosted Mac agent

resources:
  repositories:
    - repository: appiumTests
      type: git
      name: "Quotes Daily/Qoutes_Daily_Appium"

jobs:
  # Job 1: Build Release APK and publish artifact
  - job: BuildReleaseAPK
    displayName: "Build Release APK"
    pool:
      name: Default
    steps:
      - checkout: self
        clean: true

      - task: Gradle@2
        inputs:
          gradleWrapperFile: 'gradlew'
          gradleOptions: '-Xmx3072m'
          tasks: 'assembleRelease'

      - task: PublishBuildArtifacts@1
        inputs:
          PathtoPublish: 'app/build/outputs/apk/release/app-release.apk'
          ArtifactName: 'releaseApk'
          publishLocation: 'Container'

  # Job 2: Run Appium Tests using APK
  - job: RunAppiumTests
    displayName: "Run Appium Tests"
    dependsOn: BuildReleaseAPK
    pool:
      name: Default
    steps:
      # Ensure Java 11
      - script: |
          if ! java -version 2>&1 | grep '11.'; then
            echo "Java 11 not found. Installing..."
            brew tap homebrew/cask-versions
            brew install --cask temurin11
          fi
          java -version
        displayName: "Ensure Java 11 Installed"

      # Download APK artifact
      - task: DownloadBuildArtifacts@0
        inputs:
          buildType: 'current'
          downloadType: 'single'
          artifactName: 'releaseApk'
          downloadPath: '$(System.DefaultWorkingDirectory)/apk'

      # Checkout Appium test repo into a fixed folder
      - checkout: appiumTests

      # Run Appium tests
      - script: |
          cd $(Build.SourcesDirectory)
          ./gradlew clean test -PappPath=$(System.DefaultWorkingDirectory)/apk/app-release.apk
        displayName: "Run Appium Tests"

      # Publish HTML report as artifact
      - task: PublishBuildArtifacts@1
        inputs:
          PathtoPublish: '$(Build.SourcesDirectory)/app/build/reports/tests/test'
          ArtifactName: 'AppiumHTMLReport'
          publishLocation: 'Container'

  # Job 3: Build Release AAB and publish artifact (only if tests succeed)
  - job: BuildReleaseAAB
    displayName: "Build Release AAB"
    dependsOn: RunAppiumTests
    condition: succeeded('RunAppiumTests')
    pool:
      name: Default
    steps:
      - checkout: self
        clean: true

      - task: Gradle@2
        inputs:
          gradleWrapperFile: 'gradlew'
          gradleOptions: '-Xmx3072m'
          tasks: 'bundleRelease'

      - task: PublishBuildArtifacts@1
        inputs:
          PathtoPublish: 'app/build/outputs/bundle/release/app-release.aab'
          ArtifactName: 'releaseBundle'
          publishLocation: 'Container'

  # Job 4: Upload AAB to Google Play (only if tests succeed)
  - job: PublishToPlayStore
    displayName: "Upload AAB to Google Play"
    dependsOn: BuildReleaseAAB
    condition: succeeded('BuildReleaseAAB')
    pool:
      name: Default
    steps:
      - task: DownloadBuildArtifacts@0
        inputs:
          buildType: 'current'
          downloadType: 'single'
          artifactName: 'releaseBundle'
          downloadPath: '$(System.DefaultWorkingDirectory)'

      - task: GooglePlayRelease@4
        inputs:
          serviceConnection: 'Quotes Daily Service connection'
          applicationId: 'com.app.quotes_daily'
          bundleFile: '$(System.DefaultWorkingDirectory)/releaseBundle/app-release.aab'
          track: 'alpha'
          trackName: 'Closed testing - Closed Test Gamma'
